# Avito-test
## Как запустить?
Запуск из корня
```
docker-compose up --build
```
## Описание:
- В качестве роутера используется [gorilla/mux](github.com/gorilla/mux)
- Проект запускается на порту `:8080`
- В качестве хранилища используется база PostgreSQL
    + База данных содержит 3 таблицы `users`, `orders`, `report`
    + Структуру таблиц можно посмотреть в файле инициализации `_sql/db.sql`
- `script/wait-for-it.sh` - скрипт для ожидания доступности TCP хоста с портом [wait-for-it](https://github.com/vishnubob/wait-for-it)

## Описание API:
- Пример POST: Добавляет нового user, или увеличивае/уменьшает balance user'a
  ```
    curl -d '{"id": "George", "balance": 1000}' -X POST http://localhost:8080/addbalance

  ```
  Ответ:
  ```
    {"id":"George","balance":1000}
  ```
- Пример GET: Получает текущий баланс user'a
    ```
       curl -X GET  http://localhost:8080/balance?id=George
    ```
  Ответ:
    ```
      {"id":"George","balance":1000}
    ```

- Пример Post Reserve: Метод резервирования средств пользователя, принимает на вход id пользователя, id услуги, id заказа и количество денег. Условие: id заказа должно быть уникальным, а так же средств на счету пользователя должно хватать для сделки. Так же после резервирования баланса пользователя, 
деньги списываются с его счёта, то есть они зарезервированны до тех пор пока сделка не состоится или не отменится
    ```
      curl -d '{"id": "George", "id_service": "1", "id_order": "1", "amount": 500}' -X POST http://localhost:8080/reserve

    ```
  Ответ:
    ```
      {"id":"George","balance":1500,"id_servise":"1","id_order":"1","reserved_balance":500}
    ```

- Пример Patch Accept Reserve: Метод признания выручки/зарезервированного баланса(Совершения сделки). После признания поле accepted в таблице orders меняется на true и сделка добавляется в таблицу для отчётов
    ```
      curl -d '{"id": "George", "id_service": "1", "id_order": "1", "amount": 500}' -X PATCH http://localhost:8080/reserve/accept

    ```
  Ответ:
    ```
      {"id":"George","balance":1500,"id_servise":"1","id_order":"1","reserved_balance":500}
    ```

- Пример Delete reserve: Метод отмены сделки(удаления из таблицы) и зачисления средств обратно на счёт пользователя. Если сделка уже accepted=true, то такую сделку нельзя удалить
    ```
      curl -X DELETE http://localhost:8080/reserve/cancel?id=George&id_servise=1&id_order=1&amount=500

    ```
  Ответ:
    ```
      "1" this order deleted
    ```

- Пример Get Report: Метод получения отчёта по одобренным(accepted=true) услугам за определённый период (Если делать запрос через url браузера, то будет видна загрузка файла csv, иначе он сохраняется в директории проекта )
    ```
      curl -X GET  'http://localhost:8080/report?from=2022-10-29&to=2022-10-31'

    ```
  Ответ:
    ```
      [{"idServise":"1","totalSumm":500}]
    ```
- Проект структурирован на основе [go standarts](https://github.com/golang-standards/project-layout)

- Реализованы методы из **Основное задание(минимум)**, так же реализован сценарий разрезервирования денег, то есть в случае если услугу приенить не удалось то оправляется DELETE запрос для отмены резервирования и зачисления денег обратно на баланс пользователя.
- Так же выполнено Доп. задание 1.

- Дальнейшие действия на неделю
  - покрытие кода тестами
  - написание swagger файла для API
  - Доп. задание 2